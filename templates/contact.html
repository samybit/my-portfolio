{% extends "base.html" %}
{% from 'bootstrap5/form.html' import render_form %}

{% block title %}Contact - My Portfolio{% endblock %}

{% block body_class %}bg-contact{% endblock %}

{% block content %}
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6" data-aos="fade-up">

      <div class="text-center mb-5">
        <h1 class="display-4 fw-bold">Let's Talk.</h1>
        <p class="text-secondary">Have a project in mind? Send me a message.</p>
      </div>

      <div class="card bg-transparent border border-secondary p-4 glass-project">
        <div class="card-body">

          {% if success %}
          <div class="alert alert-success text-center" role="alert">
            <h4 class="alert-heading">Message Sent!</h4>
            <p>Thank you for reaching out. I will get back to you shortly.</p>
            <a href="{{ url_for('home') }}" class="btn btn-outline-success mt-3">Back to Home</a>
          </div>
          {% else %}

          <form method="POST" novalidate>
            {{ form.hidden_tag() }}

            {% for field in form if field.type not in ['SubmitField', 'CSRFTokenField'] %}
            <div class="mb-4 position-relative">

              {{ field.label(class="form-label text-secondary") }}

              {{ field(class="form-control bg-transparent text-white border-secondary", placeholder=field.label.text) }}

              <div class="live-error-msg" id="error-{{ field.id }}"></div>

            </div>
            {% endfor %}

            <button type="submit" class="btn btn-outline-light btn-lg w-100 mt-3 btn-slide-anim">
              <div class="btn-text">Send Message</div>
              <div class="icon-wrapper">
                <i class="bi bi-send-fill btn-icon"></i>
              </div>
            </button>

          </form>
          {% endif %}

        </div>
      </div>

    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const form = document.querySelector("form");
    const inputs = document.querySelectorAll(".form-control");
    const iconWrapper = document.querySelector(".icon-wrapper");
    const btnText = document.querySelector(".btn-text");

    // VALIDATION RULES
    const validators = {
      // 1. Name: Not empty, at least 2 chars
      name: (val) => val.trim().length >= 2 ? null : "Name must be at least 2 characters.",

      // 2. Email: Regex check
      email: (val) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val) ? null : "Please enter a valid email address.",

      // 3. Message: Not empty, at least 10 chars
      message: (val) => val.trim().length >= 10 ? null : "Message is too short (min 10 chars)."
    };

    // HELPER: Validate a single field
    function validateField(input) {
      const fieldName = input.name.toLowerCase(); // 'name', 'email', or 'message'
      const errorDiv = document.getElementById(`error-${input.id}`);

      // If we don't have a specific rule, skip
      if (!validators[fieldName]) return true;

      const errorMessage = validators[fieldName](input.value);

      if (errorMessage) {
        // INVALID STATE
        input.classList.add("is-invalid-custom");
        input.classList.remove("is-valid-custom");
        if (errorDiv) {
          errorDiv.innerText = errorMessage;
          errorDiv.classList.add("show");
        }
        return false;
      } else {
        // VALID STATE
        input.classList.remove("is-invalid-custom");
        input.classList.add("is-valid-custom");
        if (errorDiv) {
          errorDiv.classList.remove("show");
        }
        return true;
      }
    }

    // ATTACH LISTENERS (Real-time check)
    if (form) {
      inputs.forEach(input => {
        // Check when user types
        input.addEventListener("keyup", () => validateField(input));
        // Check when user leaves the field
        input.addEventListener("blur", () => validateField(input));
      });

      // SUBMIT HANDLER
      form.addEventListener("submit", function (e) {
        e.preventDefault(); // Stop everything first

        let isFormValid = true;

        // 1. Check ALL fields one last time
        inputs.forEach(input => {
          const isValid = validateField(input);
          if (!isValid) isFormValid = false;
        });

        if (isFormValid) {
          // SUCCESS: Play Animation & Submit
          iconWrapper.classList.add("fly-away-active");
          btnText.innerText = "Sending...";

          setTimeout(() => {
            form.submit();
          }, 600); // Wait for fly animation
        } else {
          // FAILURE: Shake the button
          const btn = document.querySelector(".btn-slide-anim");
          btn.classList.add("shake-anim");
          setTimeout(() => btn.classList.remove("shake-anim"), 500);
        }
      });
    }
  });
</script>

<style>
  @keyframes shake {

    0%,
    100% {
      transform: translateX(0);
    }

    25% {
      transform: translateX(-5px);
    }

    75% {
      transform: translateX(5px);
    }
  }

  .shake-anim {
    animation: shake 0.4s ease-in-out;
    border-color: #ff4444 !important;
    /* Flash red */
  }
</style>
{% endblock %}